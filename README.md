# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Архитектура приложения

Приложение построено по парадигме **MVP (Model–View–Presenter)**, что обеспечивает чёткое разделение ответственности и облегчает поддержку и масштабирование кода.
### Слои:
- **View**  
  Отвечает за отображение данных и взаимодействие с пользователем. Представляет собой набор компонентов, обновляющихся в ответ на изменения модели.
- **Model**  
  Хранит и управляет данными приложения. Обеспечивает бизнес-логику и абстрагирует работу с внешними источниками данных.
- **Presenter**  
  Является посредником между View и Model.  
  Получает события от View, обновляет Model, и наоборот — реагирует на изменения в Model, инициируя обновление View. Взаимодействие основано на паттерне событий через `EventEmitter`.

Такой подход делает архитектуру гибкой, модульной и удобной для тестирования.

## Описание классов, их предназначение и функции.
### Базовые компоненты

**Путь:** `src/components/base/`

---
#### `Api`

Компонент взаимодействия с бэкэндом.  
Реализует интерфейс `IApi`.

**Конструктор:**
- `baseUrl: string` — базовый URL бэкэнда.
- `options?: RequestInit = {}` — необязательные настройки запроса (например, хэдеры).

**Особенности:**
- Используется только через наследников.
**Методы:**
  - `get(uri: string): Promise<object>` — отправка GET-запроса.
  - `post(uri: string, data: object, method: ApiPostMethods): Promise<object>` — отправка POST-запроса с указанием метода (POST, PUT и т.д.).
**Приватные методы:**
  - `protected handleResponse(response: Response): Promise<object>` - обрабатывает полученный с сервера ответ типа Response.

---
#### `EventEmitter`

Брокер событий в классической реализации.  Служит механизмом связи между частями приложения. Класс используется в **презентере** для обработки пользовательских действий и координации логики, а также в **модели** и **представлении** для генерации и реакции на события, происходящие в приложении.
Реализует интерфейс `IEvents`.

**Конструктор:** без параметров.

**Методы интерфейса:**
- `on<T extends object>(event: EventName, callback: (data: T) => void): void` — установить обработчик события.
- `emit<T extends object>(event: string, data?: T): void` — инициировать событие.
- `trigger<T extends object>(event: string, context?: Partial<T>): (data: T) => void` — создать коллбек, генерирующий событие при вызове.
**Методы класса:**
- `off(eventName: EventName, callback: Subscriber)` — удаляет указанный обработчик события.
- `onAll(callback: (event: EmitterEvent) => void)` — подписывает на все события, независимо от их имени.
- `offAll()` — удаляет все зарегистрированные обработчики событий.

---
#### `Component`

Абстрактный обобщенный класс с базовой логикой графического компонента.  
Используется только через наследников.

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.

**Методы:**
- `toggleClass(element: HTMLElement, className: string, force?: boolean)` — переключает класс. С параметром `force` может насильно добавить или удалить класс.
- `render(data?: Partial<T>): HTMLElement` — возвращает корневой DOM-элемент.
**Приватные методы:**
- `protected setText(element: HTMLElement, value: unknown)` — устанавливает текст в элемент.
- `protected setDisabled(element: HTMLElement, state: boolean)` — блокирует/разблокирует элемент.
- `protected setHidden(element: HTMLElement)` — скрывает элемент.
- `protected setVisible(element: HTMLElement)` — делает элемент видимым.
- `protected setImage(element: HTMLImageElement, src: string, alt?: string)` — задаёт изображение и альтернативный текст.

---
#### `Model<T>`

Абстрактный обобщенный класс для описания модели данных.  
Используется только через наследников.

**Конструктор:**
- `data: Partial<T>` — объект с начальными данными.
- `events: IEvents` — экземпляр брокера событий.

**Метод:**
- `emit<T extends object>(eventName: string, data?: T)` — сообщает об изменении модели.

---
### Слой моделей данных

**Путь:** `src/components/model/`

---
#### `MainModel`
Класс, описывающий модель главной страницы. Хранит список товаров, id выбранного для просмотра товара, информацию о заказе. Отвечает за логику взаимодействия с этими данными. Наследует `Model`, типизируется типом `Main`. Использует родительский конструктор.

**Тип `Main`:**
```ts
export type Main = {
  catalogItems: Map<string, ProductItem>;  // товары в каталоге
  preview: string | null;                  // id товара в превью
  order: Order;                            // модель заказа
};
```

Тип, описывающий данные карточки товара.
**Тип `ProductItem`:**
```ts
export type ProductItem = {
  id: string;             // id товара
  description: string;    // описание товара
  image: string;          // ссылка на изображение товара
  title: string;          // название товара
  category: string;       // категория товара
  price: number | null;   // цена товара
};
```

Тип, описывающий данные заказа.
**Тип `Order`:**
```ts
export type Order = {
  payment: string;      // тип оплаты
  email: string;        // email покупателя
  phone: string;        // телефон покупателя
  address: string;      // адрес доставки
  total: number;        // суммарная стоимость товаров
  items: string[];      // массив id товаров
};
```

**Методы:**
- `set catalogItems(items: ProductItem[])` — заполняет каталог товарами. 
- `get catalogItems(): ProductItem[]` — возвращает все товары из каталога.
- `set preview(id: string | null)` — устанавливает выбранный товар.
- `getCartActionStatus(id: string): 'add' | 'remove' | 'disabled'` — возвращает доступный статус действий с товаром (можно добавить, удалить или ничего нельзя седлать)
- `toggleProductInOrder(id: string): void` — добавляет товар в заказ, если его там ещё нет или удаляет товар, если он там есть. 
- `clearOrder(): void` — очищает массив добавленных в заказ позиций. Очищает стоимость. 
- `get total(): number` — возвращает текущую общую стоимость.
- `get items(): string[]` — возвращает массив id добавленных товаров.
- `validatePayment(): boolean` — проверяет корректность данных формы оплаты.    
- `setPayment(payment: string, address: string): void` — сохраняет данные формы оплаты.    
- `setOrderFieldValue(field: 'address' | 'phone' | 'email' | 'payment', value: string)` - задает значение переданного поля заказа.
- `getOrderFieldValue(field: 'address' | 'phone' | 'email' | 'payment'): string` - возвращает значение переданного поля заказа.
- `get order(): Order` - возвращает объект заказа.
- `validateOrder(): ValidationResult` — валидирует данные заказа.
**Приватные методы:**
- `getItemById(id: string): ProductItem` — возвращает товар по id.    
- `getItemByIds(ids: string[]): ProductItem[]` — возвращает массив товаров по массиву id.   
- `calculateTotal(): void` — высчитывает общую стоимость товаров в заказе и заполняет соответствующее поле.

---
#### `ProductApi`

Класс взаимодействия с сервером. Наследует класс `Api`, реализует интерфейс `IProductModel`.

**Конструктор:**
- `baseUrl: string` — адрес API, передаётся в родительский конструктор.

**Методы:**
- `GetProductItem(id: string): ProductItem` — получает товар по id.    
- `GetProductList(): Promise<ProductItem[]>` — получает список всех товаров.    
- `PostOrder(orderBody: Order): OrderRespose` — отправляет заказ на сервер.

---
### Слой представления (View компоненты)

**Путь:** `src/components/View/common`

___
#### `Modal`

Класс - представление модального окна. Содержит произвольный контент, может быть закрыт кнопкой-крестиком или по клику на оверлей. Используется для отображения карточки товара, корзины или форм ввода информации.
Наследует абстрактный обобщённый класс `Component`, указывая в качестве типа данных интерфейс `IModalData`. 

**Интерфейс `IModalData`:**
```ts
interface IModalData {
    content: HTMLElement;
}
```

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.
- `events: IEvents` — интерфейс брокера событий.

**Методы:**
- `set content(count: HTMLElement)` — задать содержимое окна.
- `open()` — открыть модальное окно.
- `close()` — закрыть модальное окно.
- `render(data: IModalData): HTMLElement` — возвращает корневой DOM-элемент.

___
#### `Form`

Класс - обобщенное представление формы ввода информации. Позволяет пользователю взаимодействовать с формой и отображает сообщения об ошибках, при необходимости. В классе созданы эвентлистенеры всех интерактивных элементов с типом `input` и `submit`, для генерации событий. Используется только через наследников.
Наследует абстрактный обобщённый класс `Component`, указывая в качестве типа данных интерфейс `IFormState`. Не используется напрямую.

**Тип `Form`:**
```ts
interface IFormState {
    valid: boolean;
    errors: string;
}
```

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.
- `events: IEvents` — интерфейс брокера событий.

**Методы:**
- `set errors(val: string)` — установить текст ошибок.
- `set valid(value: boolean)` — установить признак валидности формы.
- `render(state: Partial<T> & IFormState)` — возвращает корневой DOM-элемент.

**Приватные методы:**
- `protected onInputChange(field: keyof T, value: string)` — сгенерировать событие при изменении поля

___

**Путь:** `src/components/View/`

---
#### `PageView`

Компонент представления главной страницы. Отвечает за отображение каталога товаров и количества товаров в корзине. Позволяет открыть модальное окно: с корзиной (при клике на иконку корзины). При открытии модального окна блокирует прокрутку страницы.
Наследует абстрактный обобщённый класс `Component`, указывая в качестве типа данных структуру главной страницы `ProductItem`.

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.
- `events: IEvents` — интерфейс брокера событий.

**Методы:**
- `set counter(count: number)` — установить количество товаров в корзине.
- `set gallery(items: HTMLElement[])` — поместить массив карточек в галерею.
- `set lock(isLock: boolean)` — заблокировать или разблокировать прокрутку страницы.

___
#### `CardView`

Компонент карточки товара. В зависимости от переданного контейнера формирует один из видов карточки:
- `.gallery__item .card` — карточка из галереи на главной странице    
- `.card .card_full` — карточка в модальном окне (детальный вид)    
- `.basket__item .card .card_compact` — карточка в списке корзины
Позволяет выполнить переданное действие по клику на карточку из списка карточек (открытие модального окна с подробной информацией) или клику на кнопку (добавление / удаление товара в корзину).
Наследует абстрактный обобщённый класс `Component`, указывая в качестве типа данных структуру `Card`. 

**Тип `Card`:**
```ts
export type Card = ProductItem & {
  buttonText: string;             //текст кнопки
  basketItemIndex: number;        //индекс карточки
  isButtonDisabled: boolean;      //блокировка кнопки карточки
};
```

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.
- `actions?: Action` — (необязательный) объект с обработчиками событий (например, клик по кнопке "В корзину").

**Методы:**
- `set image(val: string)` — установить значение ссылки на картинку.
- `set description(val: string)` — установить значение описания.
- `set category(val: string)` — установить значение категории.
- `set title(val: string)` — установить значение тайтла карточки.
- `set price(val: number | null)` — установить значение цены или текст `бесценно`.
- `set basketItemIndex(val: number)` — установить индекс корзины.
- `set buttonText(val: string)` — установить текст кнопки.
- `set isButtonDisabled(val: boolean)` — установить признак блокировки кнопки.

___
#### `BasketView`

Компонент отображения содержимого корзины. Отображает список товаров, общую стоимость и кнопку перехода к оформлению заказа.
Наследует абстрактный обобщённый класс `Component`, указывая в качестве типа данных тип `Order`. 

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.
- `events: IEvents` — интерфейс брокера событий.

**Методы:**
- `set basketList(items: HTMLElement[])` — установить содержимое списка карточек.
- `set basketPrice(total: number)` — установить суммарную стоимость.

___
#### `OrderView`

Компонент формы заказа. 
Наследует обобщённый класс `Form`, указывая в качестве типа данных `Order`. В зависимости от переданного контейнера формирует один из видов формы заказа:
- форма выбора типа оплаты и ввода адреса доставки  
- форма ввода контактной информации  

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.
- `eventEmiter: IEvents` — интерфейс брокера событий.

**Методы:**
- `set address(val: string)` — установить адрес доставки.
- `set phone(val: string)` — установить номер телефона.
- `set email(val: string)` — установить email.
- `set activePaymentBtn(payment: PaymentType)` — установить выбранный тип оплаты.
- `clearPaymentStyle()` — очистить выбранный тип оплаты.
- `clearAllInputs()` — очистить все поля ввода.

**Приватные методы:**
- `private get card()` — возвращает кнопку кнопку оплаты карточкой
- `private get cash()` — возвращает кнопку кнопку оплаты наличными

___
#### `SuccessView`

Компонент финального сообщения после успешного оформления заказа. Показывает сумму заказа и кнопку возврата на главный экран. Cрабатывает после успешной отправки POST запроса.
Наследует абстрактный обобщённый класс `Component`, указывая в качестве типа данных тип `Order`. 

**Конструктор:**
- `container: HTMLElement` — DOM-элемент-контейнер для компонента.
- `actions?: Action` — (необязательный) объект с обработчиками событий.

**Методы:**
- `set total(total: number)` — установить стоимость заказа.
___
### Взаимодействие классов различных слоев

Центральной точкой входа в приложение является файл `src/index.ts`. В нём создаются экземпляры всех ключевых классов: представлений, моделей и сервисов. Здесь же настраивается взаимодействие между ними через события и их обработчики.

Для организации обмена данными используется брокер событий: представления генерируют события, а `index.ts` подписывается на них и вызывает соответствующие методы моделей или других компонентов. Это позволяет отделить пользовательский интерфейс от бизнес-логики без создания отдельного слоя Presenter — его функции по сути выполняет сам `index.ts`, координируя работу приложения.

### Список событий

| Событие                         | Источник     | Описание                                                         |
| ------------------------------- | ------------ | ---------------------------------------------------------------- |
| `gallery:click`                 | `PageView`   | Клик по карточке на главной странице                             |
| `basket:click`                  | `PageView`   | Клик по корзине на главной странице                              |
| `card:click`                    | `CardView`   | Клик по кнопке карточки                                          |
| `modal:open`                    | `Modal`      | Открытие модального окна                                         |
| `modal:close`                   | `Modal`      | Закрытие модального окна                                         |
| `order_form:open`               | `BasketView` | Клик по кнопке оформления заказа                                 |
| `/^(order\|contacts).*change$/` | `Form`       | Пользователь ввел информацию в инпут формы или выбрал тип оплаты |
| `order_form:submit`             | `OrderView`  | Клик по кнопке далее в форме оплаты и адреса доставки            |
| `contacts_form:submit`          | `OrderView`  | Клик по кнопке оплатить в форме ввода email и телефона           |
| `catalog:changed`               | `MainModel`  | Обновлен каталог товаров                                         |
| `preview:changed`               | `MainModel`  | Выбран новый объект - карточка превью                            |
| `basket:changed`                | `MainModel`  | Изменилось содержимое корзины                                    |
| `order:changed`                 | `MainModel`  | Изменились данные о адресе доставки, email или телефоне          |
| `form_input_errors:changed`     | `MainModel`  | Изменились ошибки валидации                                      |


## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```